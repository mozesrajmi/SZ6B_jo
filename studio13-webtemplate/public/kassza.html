helo<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ell√°tottak T√°bl√°zata</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.css" />
    <script src="https://cdn.datatables.net/2.0.3/js/dataTables.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
    <link rel="stylesheet" href="kassza.css">
</head>
<body>
    <div class="container">
        <div class="table-wrapper">
            <div class="header">
                <h1 class="display-6">Befizet√©s</h1>
                <p id="currentDate" class="text-muted"></p>
            </div>

            <div class="bixi">
                <div class="box"> 
                    <input type="text" class="bixi" id="searchBox" placeholder="Keres√©s..." autocomplete="off" spellcheck="false" />
                    <img src="images/eleg.png" class="bixi-image">
                </div>
            </div>
            

            <div class="table-responsive">
                <table id="myTable" class="display" >
                    <thead>
                        <tr>
                            <th scope="col" class="text-center">#</th>
                            <th scope="col" class="text-center">N√âV</th>
                            <th scope="col" class="text-center">TAJ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be inserted dynamically here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Els≈ë mod√°l -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h5 class="modal-title w-100" id="modalTitle">P√°ciens adatai</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>N√©v:</strong> <span id="modalName"></span></p>
                    <p><strong>TAJ sz√°m:</strong> <span id="modalTaj"></span></p>
                </div>
                <div class="modal-footer">
                    <button id="nextModalButton" class="btn btn-primary">Tov√°bb a befizet√©sre</button>
                </div>
            </div>
        </div>
    </div>

     <!-- M√°sodik mod√°l -->
     <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h5 class="modal-title w-100" id="paymentModalTitle">Befizet√©si √∂sszeg</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Fizetend≈ë h√≥nap:</strong> <span style="color: rgb(206, 115, 237); font-size: 20px; font-family: sans-serif;" id="currentMonth"></span></p> 
                    <p><strong>Fizetend≈ë √∂sszeg:</strong> <span id="fizetendoAmount"></span></p>
                    <p><strong>M√°r egyszer Befizetett √∂sszeg:</strong> <span id="paidAmount" style="color: lightcoral;">0 Ft</span></p>
                    <p><strong>H√°tral√©k:</strong> <span id="hatralekAmount" style="color: red; font-weight: bold;">0 Ft</span></p>
                    <p><strong>T√∂bblet:</strong> <span id="tobbletAmount" style="color: green; font-weight: bold;">0 Ft</span></p>
                    <p><strong>(Ha van t√∂bblet, h√°tral√©k), √ñsszes√≠tett √∂sszeg:</strong> <span id="updatedAmount" style="color: blue; font-weight: bold;">0 Ft</span></p>
                    <!-- √öj beviteli mez≈ë -->
                    <div class="mb-3">
                        <label for="paymentInput" class="form-label"></label>
                        <input type="number" class="form-control" id="paymentInput" placeholder="√çrja be a befizetett √∂sszeget" />
                    </div>
                </div>         
                <div class="modal-footer">
                    <!-- √öj gombok -->
                    <button type="button" class="btn btn-secondary" id="resetFizetendoButton">Null√°zd a FIZETEND≈êT</button>
                    <button type="button" class="btn btn-warning" id="recalculateFizetendoButton">Sz√°mold √∫jra</button>
                    <button type="button" class="btn btn-danger" id="revertPaymentButton">Befizet√©s visszavon√°sa</button>
                    <button type="button" class="btn btn-success" id="savePaymentButton">Ment√©s</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Harmadik mod√°l -->
    <div class="modal fade" id="recalculateModal" tabindex="-1" aria-labelledby="recalculateModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recalculateModalTitle">√öjrasz√°molt Adatok</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="statusSummary">
                        <!-- St√°tusz √∂sszegz√©s itt jelenik meg -->
                    </div>
                    <table id="detailsTable" class="table">
                        <thead>
                            <tr>
                                <th>Nap</th>
                                <th>St√°tusz</th>
                                <th>Napi k√∂lts√©g</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Adatok itt jelennek meg -->
                        </tbody>
                    </table>
                    <p><strong>√ñsszes k√∂lts√©g:</strong> <span id="totalCost"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="saveRecalculatedAmount" style="background-color: green;">Ment√©s</button>
                </div>
            </div>
        </div>
    </div>
    


    <script>
 $(document).ready(function () {
    const table = $('#myTable').DataTable({
        autoWidth: false,
        responsive: true,
        dom: 't',
        pageLength: 150,
        columnDefs: [
        { className: "text-center align-middle", targets: "_all" }],
    });

    let selectedTaj = null;
    let patientId = null;

   
    // Keres√©s a t√°bl√°zatban
    $('#searchBox').on('input', function () {
        const searchValue = this.value.slice(0, 50);
        table.search(searchValue).draw();
    });

    // Adatok bet√∂lt√©se
    function loadData() {
        $.ajax({
            url: '/getEllatottPatients',
            method: 'GET',
            success: function (data) {
                table.clear();
                data.forEach((patient, index) => {
                    table.row.add([
                        index + 1,
                        `<span class="clickable-name">${patient.NEV}</span>`,
                        patient.TAJ
                    ]).draw(false);
                });

                // Sor kiv√°laszt√°s
                $('#myTable tbody').on('click', '.clickable-name', function () {
                    const rowData = table.row($(this).closest('tr')).data();
                    selectedTaj = rowData[2];
                    const name = $(this).text();
                    openModal(name, rowData[2]);
                });
            },
            error: function (xhr, status, error) {
                console.error('Hiba t√∂rt√©nt az adatok bet√∂lt√©sekor:', error);
            }
        });
    }

    // Els≈ë mod√°l megnyit√°sa
    function openModal(name, taj) {
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;

        $.ajax({
            url: '/getPatientIdByTaj',
            method: 'GET',
            data: { taj },
            success: function (response) {
                const patientId = response.id;

                // Ellen≈ërizz√ºk, hogy t√∂rt√©nt-e m√°r befizet√©s
                $.ajax({
                    url: '/checkIfPaid',
                    method: 'GET',
                    data: { id: patientId, year: currentYear, month: currentMonth },
                    success: function (data) {
                        if (data.paid) {
                            // Ha m√°r befizetett, k√©rdezz√ºk meg, hogy m√≥dos√≠tani akarja-e
                            if (confirm('Ez a p√°ciens m√°r befizetett az aktu√°lis h√≥napra! Szeretn√© m√≥dos√≠tani a befizet√©st?')) {
                                // Enged√©lyezz√ºk a m√≥dos√≠t√°st, √©s nyissuk meg a mod√°lt
                                $('#modalName').text(name);
                                $('#modalTaj').text(taj);
                                $('#detailsModal').modal('show');
                            }
                        } else {
                            // Ha m√©g nem fizetett, nyissuk meg a mod√°lt
                            $('#modalName').text(name);
                            $('#modalTaj').text(taj);
                            $('#detailsModal').modal('show');
                        }
                    },
                    error: function () {
                        alert('Hiba t√∂rt√©nt a befizet√©s √°llapot√°nak ellen≈ërz√©sekor.');
                    }
                });
            },
            error: function () {
                alert('Nem siker√ºlt lek√©rni a p√°ciens ID-j√°t.');
            }
        });
    }


    // "Tov√°bb a befizet√©sre" gomb
    $('#nextModalButton').on('click', function () {
    if (selectedTaj) {
        const today = new Date();
        let prevMonth = today.getMonth(); // Jelenlegi h√≥nap -1 (0-alap√∫ index)
        let prevYear = today.getFullYear();

        // H√≥napnevek t√∂mb - Ezt a r√©szt mindig el≈ëbb defini√°ld!
        const monthNames = [
            "Janu√°r", "Febru√°r", "M√°rcius", "√Åprilis", "M√°jus", "J√∫nius",
            "J√∫lius", "Augusztus", "Szeptember", "Okt√≥ber", "November", "December"
        ];

        // Ha janu√°r van, akkor az el≈ëz≈ë h√≥nap december, √©s az √©vet is cs√∂kkenteni kell
        if (prevMonth === 0) {
            prevMonth = 12;
            prevYear -= 1;
        }

        // Az el≈ëz≈ë h√≥nap nev√©nek be√°ll√≠t√°sa
        const prevMonthName = monthNames[prevMonth - 1];
        $('#currentMonth').text(prevMonthName);

        // TAJ sz√°m alapj√°n p√°ciens ID lek√©r√©se
        $.ajax({
            url: '/getPatientIdByTaj',
            method: 'GET',
            data: { taj: selectedTaj },
            success: function (response) {
                patientId = response.id;
                
                // Fizetend≈ë √∂sszeg lek√©r√©se az el≈ëz≈ë h√≥napra
                $.ajax({
                    url: '/getFizetendoById',
                    method: 'GET',
                    data: { id: patientId, year: prevYear, month: prevMonth },
                    success: function (response) {
                        const fizetendoAmount = parseFloat(response.fizetendo || 0);
                        $('#fizetendoAmount').text(fizetendoAmount.toLocaleString() + ' Ft');
                    },
                    error: function () {
                        alert('Nem siker√ºlt lek√©rni a fizetend≈ë √∂sszeget az el≈ëz≈ë h√≥napra.');
                    }
                });

                $('#detailsModal').modal('hide');
                $('#paymentModal').modal('show');
            },
            error: function () {
                alert('Nem siker√ºlt lek√©rni a p√°ciens ID-j√°t.');
            }
        });
    }
});



    // Fizetend≈ë √∂sszeg bet√∂lt√©se
    function fetchFizetendo(patientId, year, month) {
    $.ajax({
        url: '/getFizetendoById',
        method: 'GET',
        data: { id: patientId, year: year, month: month },
        success: function (response) {
            const fizetendoAmount = parseFloat(response.fizetendo || 0);
            $('#fizetendoAmount').text(fizetendoAmount.toLocaleString() + ' Ft');

            // Lek√©rj√ºk a fizetett √∂sszeget
            $.ajax({
                url: '/getPaidAmount',
                method: 'GET',
                data: { id: patientId, year: year, month: month },
                success: function (paidResponse) {
                    const paidAmount = parseFloat(paidResponse.paid || 0);
                    $('#paidAmount').text(paidAmount.toLocaleString() + ' Ft');
                },
                error: function () {
                    alert('M√©g nincs befizetett √∂sszeg.');
                }
            });

            // H√°tral√©k √©s t√∂bblet friss√≠t√©se
            $.ajax({
                url: '/getHatralekTobblet',
                method: 'GET',
                data: { id: patientId, year: year, month: month },
                success: function (response) {
                    const hatralek = parseFloat(response.hatralek || 0);
                    const tobblet = parseFloat(response.tobblet || 0);

                    $('#hatralekAmount').text(hatralek.toLocaleString() + ' Ft');
                    $('#tobbletAmount').text(tobblet.toLocaleString() + ' Ft');

                    const updatedAmount = fizetendoAmount + hatralek - tobblet;
                    $('#updatedAmount').text(updatedAmount.toLocaleString() + ' Ft');
                },
                error: function () {
                    alert('Nem siker√ºlt lek√©rni a h√°tral√©kot √©s t√∂bbletet.');
                }
            });

        },
        error: function () {
            alert('Nem siker√ºlt lek√©rni a fizetend≈ë √∂sszeget.');
        }
    });
}

    // Befizet√©s visszavon√°sa
    $('#revertPaymentButton').on('click', function () {
        if (!patientId) {
            alert('Nincs kiv√°lasztva p√°ciens!');
            return;
        }

        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;

        if (confirm('Biztosan visszavonja a befizet√©st, h√°tral√©kot √©s t√∂bbletet? A t√∂bblet √©s a h√°tral√©k a k√∂vetkez≈ë h√≥naphoz ker√ºl!')) {
            $.ajax({
                url: '/revertPayment',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: patientId, year: currentYear, month: currentMonth }),
                success: function (response) {
                    alert(response.message);
                    $('#paymentModal').modal('hide');
                    fetchFizetendo(patientId, currentYear, currentMonth); // Adatok friss√≠t√©se az aktu√°lis h√≥napra
                },
                error: function () {
                    alert('Hiba t√∂rt√©nt a befizet√©s visszavon√°sa sor√°n.');
                }
            });
        }
    });



    // Seg√©df√ºggv√©ny: sz√°m form√°z√°sa
    function formatNumber(number) {
        return new Intl.NumberFormat('hu-HU', { maximumFractionDigits: 0 }).format(number);
    }

    $('#savePaymentButton').on('click', function () {
    const enteredAmount = parseFloat($('#paymentInput').val());
    const displayedMonth = $('#currentMonth').text(); // A fizetend≈ë h√≥nap
    const currentFizetendo = parseFloat($('#fizetendoAmount').text().replace(/[^0-9]/g, ''));
    const currentPaid = parseFloat($('#paidAmount').text().replace(/[^0-9]/g, '')) || 0;
    
    if (!patientId) {
        alert('Nincs kiv√°lasztva p√°ciens!');
        return;
    }

    if (isNaN(enteredAmount)) {
        alert('K√©rj√ºk, adjon meg egy √©rv√©nyes √∂sszeget!');
        return;
    }

    // üìå Meghat√°rozzuk a fizetend≈ë h√≥napot (pl. febru√°r, ha febru√°rban janu√°rt fizetsz)
    const monthNames = [
        "Janu√°r", "Febru√°r", "M√°rcius", "√Åprilis", "M√°jus", "J√∫nius",
        "J√∫lius", "Augusztus", "Szeptember", "Okt√≥ber", "November", "December"
    ];
    
    const prevMonthIndex = monthNames.indexOf(displayedMonth); // A kijelzett h√≥nap indexe
    let prevMonth = prevMonthIndex + 1; // Az el≈ëz≈ë h√≥nap
    let prevYear = new Date().getFullYear();

    if (prevMonth === 12 && new Date().getMonth() === 0) {
        prevYear -= 1; // Ha janu√°r van, akkor el≈ëz≈ë √©v december√©hez kell menteni
    }

    // üìå Meghat√°rozzuk azt a h√≥napot, ahova a h√°tral√©k √©s t√∂bblet ment≈ëdik (az aktu√°lis h√≥nap, pl. febru√°r)
    let currentDate = new Date();
    let nextMonth = currentDate.getMonth() + 1; // Az aktu√°lis h√≥nap
    let nextYear = currentDate.getFullYear();

    const difference = currentFizetendo - enteredAmount;

    // üìå 1Ô∏è‚É£ Befizet√©s ment√©se a fizetend≈ë h√≥naphoz (pl. janu√°r)
    $.ajax({
        url: '/updateFizetett',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            id: patientId,
            amount: enteredAmount,
            year: prevYear,
            month: prevMonth
        }),
        success: function () {
            alert(`Befizet√©s mentve ${displayedMonth} h√≥napra!`);

            // üîπ **Azonnali friss√≠t√©s a mod√°lban**
            fetchFizetendo(patientId, prevYear, prevMonth);

            // üìå 2Ô∏è‚É£ H√°tral√©k ment√©se az aktu√°lis h√≥naphoz (pl. febru√°r)
            if (difference > 0) {
                $.ajax({
                    url: '/updateHatralek',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        id: patientId,
                        hatralek: parseFloat(difference),
                        year: nextYear, // üìå Az aktu√°lis h√≥naphoz (pl. febru√°r)
                        month: nextMonth
                    }),
                    success: function () {
                        alert(`H√°tral√©k mentve ${monthNames[nextMonth - 1]} h√≥napra!`);
                        fetchFizetendo(patientId, prevYear, prevMonth);
                    },
                    error: function (xhr) {
                        console.error('Hiba t√∂rt√©nt a h√°tral√©k ment√©se sor√°n:', xhr.responseText);
                    }
                });
            } 
            // üìå 3Ô∏è‚É£ T√∂bblet ment√©se az aktu√°lis h√≥naphoz (pl. febru√°r)
            else if (difference < 0) {
                $.ajax({
                    url: '/updateTobblet',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        id: patientId,
                        tobblet: difference * -1,
                        year: nextYear, // üìå Az aktu√°lis h√≥naphoz (pl. febru√°r)
                        month: nextMonth
                    }),
                    success: function () {
                        alert(`T√∂bblet sikeresen mentve ${monthNames[nextMonth - 1]} h√≥napra!`);
                        fetchFizetendo(patientId, prevYear, prevMonth);
                        $('#paymentInput').val('');
                    },
                    error: function (xhr) {
                        console.error('Hiba t√∂rt√©nt a t√∂bblet ment√©se sor√°n:', xhr.responseText);
                    }
                });
            }
        },
        error: function () {
            alert('Hiba t√∂rt√©nt a befizet√©s ment√©se sor√°n!');
        }
    });
});





    // FIZETENDO null√°z√°sa
    $('#resetFizetendoButton').on('click', function () {
        if (!patientId) {
            alert('Nincs kiv√°lasztva p√°ciens!');
            return;
        }

        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;

        if (confirm('Biztosan null√°zni szeretn√© a fizetend≈ë √∂sszeget?')) {
            $.ajax({
                url: '/resetFizetendo',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    id: patientId,
                    year: currentYear,
                    month: currentMonth,
                }),
                success: function (response) {
                    alert(response.message);
                    $('#fizetendoAmount').text('0 Ft'); // Friss√≠tj√ºk a mod√°lis n√©zetet
                },
                error: function () {
                    alert('Hiba t√∂rt√©nt a FIZETENDO null√°z√°sakor.');
                }
            });
        }
    });


     // FIZETENDO √∫jrasz√°mol√°sa
     $('#recalculateFizetendoButton').on('click', function () {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth() + 1;
        const currentYear = currentDate.getFullYear();

        if (!patientId) {
            alert('Nincs kiv√°lasztva p√°ciens!');
            return;
        }

        $.ajax({
            url: '/recalculate',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ id: patientId, year: currentYear, month: currentMonth }),
            success: function (response) {
                const detailsTableBody = $('#detailsTable tbody');
                const statusSummary = $('#statusSummary');
                detailsTableBody.empty();
                statusSummary.empty();

                // St√°tusz √∂sszegz√©s friss√≠t√©se
                statusSummary.append(`
                    <h5>St√°tusz √ñsszegz√©s:</h5>
                    <p>K√≥rh√°zban t√∂lt√∂tt napok: ${response.yearlyHospitalDays}</p>
                    <p>Helyfoglal√°s napok: ${response.yearlyReservedDays}</p>
                `);

                // T√°bl√°zat felt√∂lt√©se napi adatokkal
                response.details.forEach(detail => {
                    detailsTableBody.append(`
                        <tr>
                            <td>${detail.day}</td>
                            <td>${detail.status}</td>
                            <td>${formatNumber(detail.dailyCost)} Ft</td>
                        </tr>
                    `);
                });

                // Teljes k√∂lts√©g friss√≠t√©se
                $('#totalCost').text(formatNumber(response.totalCost) + ' Ft');

                // √öj mod√°lis megnyit√°sa
                $('#recalculateModal').modal('show');
            },
            error: function () {
                alert('Hiba t√∂rt√©nt az √∫jrasz√°mol√°s sor√°n!');
            }
        });
    });

    function formatNumber(number) {
        return new Intl.NumberFormat('hu-HU', { maximumFractionDigits: 0 }).format(number);
    }

    //fizetesujraszmito ment√©se
    $('#saveRecalculatedAmount').on('click', function () {
        const recalculatedTotal = parseFloat($('#totalCost').text().replace(/[^0-9]/g, '')); // Az √∫j √∂sszeg
        const currentFizetendo = parseFloat($('#fizetendoAmount').text().replace(/[^0-9]/g, '')); // A jelenlegi √∂sszeg

        if (recalculatedTotal !== currentFizetendo) {
            // Friss√≠t√©s az adatb√°zisban
            $.ajax({
                url: '/updateFizetendo',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    id: patientId,
                    newFizetendo: recalculatedTotal
                }),
                success: function () {
                    alert('Az √∫j fizetend≈ë √∂sszeg sikeresen friss√≠tve!');
                    $('#recalculateModal').modal('hide'); // Z√°rjuk a mod√°lt
                    $('#fizetendoAmount').text(recalculatedTotal + ' Ft'); // Friss√≠tj√ºk a megjelen√≠tett fizetend≈ë √∂sszeget
                },
                error: function () {
                    alert('Hiba t√∂rt√©nt a fizetend≈ë √∂sszeg friss√≠t√©se sor√°n.');
                }
            });
        } else {
            alert('A fizetend≈ë √∂sszeg m√°r egyezik, nincs sz√ºks√©g friss√≠t√©sre.');
        }
    });


    
    // Adatok bet√∂lt√©se
    loadData();
});

        
    </script>
</body>
</html>
